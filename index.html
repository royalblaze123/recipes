<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Atlas Recipe Index – Auto Folder Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--
    Atlas Auto-Index v6
    - For Safari + Simple Server on port 8080
    - Auto-scans current folder's HTTP directory listing for *.html files.
    - Persists "Uploaded" markers per filename (localStorage + cookie).
    - Export panel for Atlas: category | filename | title.
    - "Copy all" button for quick clipboard.
    - NEW: "Download .txt" button to save the export text as a local file
      (e.g., atlas-recipe-export.txt) for easy upload back into ChatGPT.
  -->

  <style>
    :root {
      --bg: #05070b;
      --card-bg: #0f1118;
      --accent: #16c1b8;
      --accent-soft: rgba(22, 193, 184, 0.18);
      --accent-strong: #3fe0d8;
      --text-main: #f7f7fb;
      --text-muted: #9aa3c0;
      --border-subtle: #23263a;
      --uploaded-bg: rgba(48, 209, 88, 0.14);
      --uploaded-border: rgba(48, 209, 88, 0.6);
      --uploaded-text: #4cd964;
      --pending-bg: rgba(255, 214, 10, 0.12);
      --pending-border: rgba(255, 214, 10, 0.65);
      --pending-text: #ffd60a;
      --radius-card: 14px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #15182a 0, #020308 55%, #000 100%);
      color: var(--text-main);
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: linear-gradient(135deg, #101321, #080a12);
      border-radius: var(--radius-card);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow:
        0 18px 45px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(22, 193, 184, 0.18), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(93, 140, 255, 0.16), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 1.05rem;
      font-weight: 650;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.24);
      background: radial-gradient(circle at 0 0, rgba(22, 193, 184, 0.28), transparent 60%);
      color: #e5fbff;
      white-space: nowrap;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-bottom: 10px;
    }

    .pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.14);
      color: var(--text-muted);
      background: rgba(8, 12, 22, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .pill.accent {
      border-color: var(--accent);
      color: var(--accent-strong);
      background: rgba(5, 22, 26, 0.96);
    }

    .table-wrapper {
      max-height: calc(100vh - 300px);
      border-radius: 10px;
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(3, 6, 15, 0.96);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 560px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    thead tr {
      background: linear-gradient(90deg, rgba(22, 193, 184, 0.2), rgba(16, 19, 33, 0.98));
    }

    th, td {
      padding: 6px 8px;
      font-size: 0.78rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #eaf4ff;
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 3;
    }

    tbody tr:nth-child(odd) {
      background: rgba(9, 11, 20, 0.96);
    }

    tbody tr:nth-child(even) {
      background: rgba(6, 8, 16, 0.96);
    }

    tbody tr.uploaded {
      opacity: 0.78;
    }

    tbody tr.uploaded td.name-cell {
      color: var(--uploaded-text);
    }

    tbody tr.uploaded td.name-cell::before {
      content: "✓ ";
      color: var(--uploaded-text);
      font-weight: 600;
    }

    .category-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 76px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--pending-border);
      font-size: 0.7rem;
      cursor: pointer;
      user-select: none;
      background: var(--pending-bg);
      color: var(--pending-text);
      margin-top: 4px;
    }

    .status-pill.uploaded {
      border-color: var(--uploaded-border);
      background: var(--uploaded-bg);
      color: var(--uploaded-text);
    }

    .link-cell a {
      color: var(--accent-strong);
      text-decoration: none;
      font-size: 0.78rem;
      cursor: pointer;
    }

    .link-cell a:hover {
      text-decoration: underline;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
      font-size: 0.72rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .toolbar-right {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button.small-btn {
      font-size: 0.7rem;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(5, 9, 18, 0.96);
      color: var(--text-main);
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.small-btn:active {
      transform: translateY(1px);
    }

    button.small-btn.clear {
      border-color: rgba(255, 92, 122, 0.8);
      color: #ffd8e1;
    }

    .hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .error {
      margin-top: 8px;
      font-size: 0.76rem;
      color: #ff7b8a;
    }

    .export-panel {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }

    .export-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .export-textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 9px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(3, 6, 15, 0.96);
      color: #eaf4ff;
      font-size: 0.75rem;
      padding: 6px 8px;
      resize: vertical;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 12px 10px 10px;
      }
      .card-title {
        font-size: 0.95rem;
      }
      .badge {
        display: none;
      }
      th:nth-child(3),
      td:nth-child(3) {
        display: none; /* hide file column on small screens */
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-inner">
      <div class="card-header">
        <div class="card-title">
          Atlas Recipe Index
          <span class="badge">Auto Folder Scan • v6</span>
        </div>
      </div>
      <div class="card-subtitle">
        This index auto-builds from the HTML files in the same folder (via Simple Server directory listing). 
        Your “Uploaded” markers are stored in Safari (local storage + cookie) per filename. The export panel 
        at the bottom lets you generate a compact text list you can paste or upload back into ChatGPT so Atlas can 
        avoid duplicates when creating new recipes.
      </div>

      <div class="pill-row">
        <div class="pill accent">Auto-scan *.html in this folder</div>
        <div class="pill">Tap status pill to toggle Uploaded</div>
        <div class="pill">Export list for Atlas</div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 16%;">Category</th>
              <th style="width: 42%;">Recipe</th>
              <th style="width: 22%;">File</th>
              <th style="width: 20%;">Open</th>
            </tr>
          </thead>
          <tbody id="recipeTableBody">
            <!-- Rows are generated by script -->
          </tbody>
        </table>
      </div>

      <div class="toolbar">
        <div>
          Upload state is stored per filename in local storage + a cookie on this device.
        </div>
        <div class="toolbar-right">
          <button class="small-btn clear" id="clearStatesBtn" type="button">
            Clear all upload markers
          </button>
        </div>
      </div>

      <div class="export-panel">
        <div class="export-label">
          Export for Atlas: one recipe per line as<br>
          <code>category | filename | title</code>
        </div>
        <div class="toolbar" style="margin-top: 4px; margin-bottom: 4px;">
          <div>
            Tap “Build export list” after adding new recipes. Use “Copy all” to paste into chat, or “Download .txt” to save a file you can upload.
          </div>
          <div class="toolbar-right">
            <button class="small-btn" id="buildExportBtn" type="button">
              Build export list
            </button>
            <button class="small-btn" id="copyExportBtn" type="button">
              Copy all
            </button>
            <button class="small-btn" id="downloadExportBtn" type="button">
              Download .txt
            </button>
          </div>
        </div>
        <textarea id="exportTextarea" class="export-textarea" readonly
          placeholder="Tap ‘Build export list’ to generate a snapshot of all recipes in this folder..."></textarea>
      </div>

      <div class="hint">
        Tip: Bookmark this URL or add it to your Home Screen so you always open the index from the same origin 
        (http://localhost:8080/atlas-recipe-index-auto.html). Add new recipes to this folder and refresh – 
        they will appear automatically.
      </div>
      <div id="errorMsg" class="error" style="display:none;"></div>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "atlas_recipe_index_uploaded_by_filename_v2";

      function readCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
          }
        }
        return null;
      }

      function loadState() {
        // localStorage first
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            return JSON.parse(raw) || {};
          }
        } catch (e) {}

        // cookie fallback
        try {
          const cookieVal = readCookie(STORAGE_KEY);
          if (cookieVal) {
            return JSON.parse(cookieVal) || {};
          }
        } catch (e) {}

        return {};
      }

      function saveState(state) {
        const json = JSON.stringify(state);
        try {
          localStorage.setItem(STORAGE_KEY, json);
        } catch (e) {}
        try {
          const maxAge = 60 * 60 * 24 * 365 * 5; // 5 years
          document.cookie =
            STORAGE_KEY +
            "=" +
            encodeURIComponent(json) +
            "; max-age=" +
            maxAge +
            "; path=/";
        } catch (e) {}
      }

      function toTitle(str) {
        return str
          .split("-")
          .filter(Boolean)
          .map(function (part) {
            return part.charAt(0).toUpperCase() + part.slice(1);
          })
          .join(" ");
      }

      function deriveCategory(filename) {
        const base = filename.replace(/\.html$/i, "");
        const parts = base.split("-");
        if (parts.length === 0) return "misc";
        return parts[0].toLowerCase();
      }

      function deriveTitle(filename) {
        const base = filename.replace(/\.html$/i, "");
        const parts = base.split("-");
        if (parts.length <= 1) {
          return toTitle(base);
        }
        const nameParts = parts.slice(1);
        return toTitle(nameParts.join("-"));
      }

      const state = loadState();
      const tbody = document.getElementById("recipeTableBody");
      const errorMsg = document.getElementById("errorMsg");
      const exportTextarea = document.getElementById("exportTextarea");

      function buildRow(filename) {
        const category = deriveCategory(filename);
        const title = deriveTitle(filename);
        const tr = document.createElement("tr");
        tr.className = "recipe-row";
        tr.setAttribute("data-filename", filename);
        tr.setAttribute("data-category", category);
        tr.setAttribute("data-title", title);

        const tdCat = document.createElement("td");
        const catSpan = document.createElement("span");
        catSpan.className = "category-pill";
        catSpan.textContent = category;
        tdCat.appendChild(catSpan);

        const tdName = document.createElement("td");
        tdName.className = "name-cell";
        tdName.textContent = title;

        const tdFile = document.createElement("td");
        tdFile.textContent = filename;

        const tdOpen = document.createElement("td");
        tdOpen.className = "link-cell";
        const link = document.createElement("a");
        link.href = filename;
        link.textContent = "Open card";
        tdOpen.appendChild(link);

        const statusPill = document.createElement("div");
        statusPill.className = "status-pill";
        statusPill.setAttribute("data-role", "status");
        tdOpen.appendChild(statusPill);

        tr.appendChild(tdCat);
        tr.appendChild(tdName);
        tr.appendChild(tdFile);
        tr.appendChild(tdOpen);

        // Apply saved state
        if (state[filename]) {
          tr.classList.add("uploaded");
          statusPill.classList.add("uploaded");
          statusPill.textContent = "Uploaded";
        } else {
          tr.classList.remove("uploaded");
          statusPill.classList.remove("uploaded");
          statusPill.textContent = "Not uploaded";
        }

        // Toggle on pill tap
        statusPill.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          const isUploaded = !!state[filename];
          state[filename] = !isUploaded;
          if (state[filename]) {
            tr.classList.add("uploaded");
            statusPill.classList.add("uploaded");
            statusPill.textContent = "Uploaded";
          } else {
            tr.classList.remove("uploaded");
            statusPill.classList.remove("uploaded");
            statusPill.textContent = "Not uploaded";
          }
          saveState(state);
        });

        // Open card in SAME TAB and mark uploaded
        link.addEventListener("click", function (e) {
          e.preventDefault();
          state[filename] = true;
          tr.classList.add("uploaded");
          statusPill.classList.add("uploaded");
          statusPill.textContent = "Uploaded";
          saveState(state);
          window.location.href = filename;
        });

        return tr;
      }

      function scanFolder() {
        var dirUrl = window.location.href.replace(/[^/]*$/, "");
        fetch(dirUrl, { cache: "no-cache" })
          .then(function (resp) { return resp.text(); })
          .then(function (htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, "text/html");
            const links = Array.prototype.slice.call(doc.querySelectorAll("a[href]"));

            const seen = new Set();
            const htmlFiles = links
              .map(function (a) { return a.getAttribute("href") || ""; })
              .map(function (href) {
                if (!href) return null;
                if (href === "../" || href === "./" || href.startsWith("#")) return null;
                if (/^https?:/i.test(href)) return null;
                if (!/\.html?$/i.test(href)) return null;
                const parts = href.split("/");
                const filename = parts[parts.length - 1];
                return filename;
              })
              .filter(function (x) { return !!x; })
              .filter(function (filename) {
                if (/atlas-recipe-index-auto/i.test(filename)) return false;
                return true;
              });

            tbody.innerHTML = "";

            htmlFiles.forEach(function (filename) {
              if (seen.has(filename)) return;
              seen.add(filename);
              const row = buildRow(filename);
              tbody.appendChild(row);
            });

            if (htmlFiles.length === 0) {
              errorMsg.style.display = "block";
              errorMsg.textContent = "No .html recipe files found in this folder listing. " +
                "Make sure Simple Server is showing a directory index and that your recipe cards " +
                "are in the same folder as this index.";
            } else {
              errorMsg.style.display = "none";
            }
          })
          .catch(function (err) {
            console.error(err);
            errorMsg.style.display = "block";
            errorMsg.textContent = "Could not read folder listing via HTTP. " +
              "If Simple Server does not show a directory index page, auto-scan may not work.";
          });
      }

      function buildExportText() {
        const rows = Array.prototype.slice.call(
          tbody.querySelectorAll(".recipe-row")
        );
        const lines = rows.map(function (row) {
          const category = row.getAttribute("data-category") || "";
          const filename = row.getAttribute("data-filename") || "";
          const title = row.getAttribute("data-title") || "";
          return category + " | " + filename + " | " + title;
        });
        exportTextarea.value = lines.join("\n");
        exportTextarea.scrollTop = 0;
      }

      function copyExportText() {
        if (!exportTextarea.value) return;
        exportTextarea.focus();
        exportTextarea.select();
        try {
          document.execCommand("copy");
        } catch (e) {
          // Ignore; user can still manually copy from selected text
        }
      }

      function downloadExportText() {
        // Ensure there's content; if not, build first
        if (!exportTextarea.value) {
          buildExportText();
          if (!exportTextarea.value) return;
        }
        const text = exportTextarea.value;
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "atlas-recipe-export.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.addEventListener("DOMContentLoaded", function () {
        scanFolder();

        const clearBtn = document.getElementById("clearStatesBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", function () {
            if (!confirm("Clear all 'Uploaded' markers for this index (per filename)?")) return;
            Object.keys(state).forEach(function (k) { delete state[k]; });
            saveState(state);
            const rows = tbody.querySelectorAll(".recipe-row");
            rows.forEach(function (row) {
              row.classList.remove("uploaded");
              const pill = row.querySelector('.status-pill[data-role="status"]');
              if (pill) {
                pill.classList.remove("uploaded");
                pill.textContent = "Not uploaded";
              }
            });
          });
        }

        const buildExportBtn = document.getElementById("buildExportBtn");
        if (buildExportBtn) {
          buildExportBtn.addEventListener("click", function () {
            buildExportText();
          });
        }

        const copyExportBtn = document.getElementById("copyExportBtn");
        if (copyExportBtn) {
          copyExportBtn.addEventListener("click", function () {
            copyExportText();
          });
        }

        const downloadExportBtn = document.getElementById("downloadExportBtn");
        if (downloadExportBtn) {
          downloadExportBtn.addEventListener("click", function () {
            downloadExportText();
          });
        }
      });
    })();
  </script>
</body>
</html>
